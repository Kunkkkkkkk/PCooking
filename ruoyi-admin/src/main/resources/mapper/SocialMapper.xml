<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.pda.mapper.SocialMapper">
    <resultMap type="com.ruoyi.pda.domain.Social" id="SocialResult">
        <id property="socialId" column="social_id" />
        <result property="userId" column="user_id" />
        <result property="content" column="content" />
        <result property="imageUrl" column="image_url" />
        <result property="imageHeight" column="image_height" />
        <result property="tags" column="tags" />
        <result property="status" column="status" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
        <result property="likeCount" column="like_count" />
        <result property="commentCount" column="comment_count" />
        <association property="user" javaType="com.ruoyi.common.core.domain.entity.SysUser">
            <id property="userId" column="user_id" />
            <result property="nickName" column="nick_name" />
            <result property="avatar" column="avatar" />
        </association>
    </resultMap>

    <sql id="selectSocialVo"> select s.social_id, s.user_id, s.content, s.image_url, s.image_height,
        s.tags, s.status, s.create_time, s.update_time, (select count(*) from master_social_like l
        where l.social_id = s.social_id) as like_count, (select count(*) from master_social_comment
        c where c.social_id = s.social_id and c.status = '0') as comment_count, u.nick_name,
        u.avatar from master_social s left join sys_user u on s.user_id = u.user_id </sql>

    <select id="selectSocialList" parameterType="com.ruoyi.pda.domain.Social"
        resultMap="SocialResult">
        <include refid="selectSocialVo" />
        <where> s.status = '0' <if test="userId != null"> AND
        s.user_id = #{userId} </if>
            <if test="content != null and content != ''"> AND s.content like
        concat('%', #{content}, '%') </if>
            <if test="tags != null and tags != ''"> AND s.tags like
        concat('%', #{tags}, '%') </if>
        </where> order by s.create_time desc </select>

    <select id="selectSocialById" parameterType="Long" resultMap="SocialResult">
        <include refid="selectSocialVo" /> where s.social_id = #{socialId} and s.status = '0' </select>

    <select id="checkSocialLikedByUser" resultType="Integer"> select count(1) from
        master_social_like where social_id = #{socialId} and user_id = #{userId} </select>

    <insert id="insertSocial" parameterType="com.ruoyi.pda.domain.Social" useGeneratedKeys="true"
        keyProperty="socialId"> insert into master_social ( user_id, content, image_url,
        image_height, tags, status, create_time ) values ( #{userId}, #{content}, #{imageUrl},
        #{imageHeight}, #{tags}, #{status}, sysdate() ) </insert>

    <update id="updateSocial" parameterType="com.ruoyi.pda.domain.Social"> update master_social <set>
            <if test="content != null and content != ''">content = #{content},</if>
            <if
                test="imageUrl != null and imageUrl != ''">image_url = #{imageUrl},</if>
            <if
                test="imageHeight != null">image_height = #{imageHeight},</if>
            <if
                test="tags != null">tags = #{tags},</if>
            <if test="status != null">status =
        #{status},</if> update_time = sysdate() </set> where social_id = #{socialId} </update>

    <delete id="deleteSocialById" parameterType="Long"> update master_social set status = '1' where
        social_id = #{socialId} </delete>

    <delete id="deleteSocialByIds" parameterType="String"> update master_social set status = '1'
        where social_id in <foreach item="socialId" collection="array" open="(" separator=","
            close=")"> #{socialId} </foreach>
    </delete>

    <update id="likeSocial" parameterType="Long"> update master_social set like_count = like_count +
        1 where social_id = #{socialId} </update>

    <update id="updateCommentCount" parameterType="Long"> update master_social set comment_count =
        (select count(*) from master_social_comment where social_id = #{socialId} and status = '0')
        where social_id = #{socialId} </update>
</mapper>